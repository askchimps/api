generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum ROLE {
  SUPER_ADMIN
  OWNER
  ADMIN
  USER
}

enum COST_TYPE {
  STT
  LLM
  TTS
  VAPI
  MISC
}

enum AGENT_TYPE {
  CHAT
  CALL
  HYBRID
}

enum CHAT_SOURCE {
  WHATSAPP
  INSTAGRAM
}

enum CALL_SOURCE {
  AUTOMATION
  WEBSITE
  MANUAL
}

enum MESSAGE_TYPE {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  GIF
  DOCUMENT
}

model User {
  id             String  @id
  name           String
  email          String  @unique
  phone_number   String? @unique
  is_super_admin Int     @default(0)

  is_disabled Int      @default(0)
  is_deleted  Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  user_organisations UserOrganisation[]

  @@index([email])
  @@index([phone_number])
  @@index([is_deleted, is_disabled])
}

model Organisation {
  id                               Int    @id @default(autoincrement())
  name                             String
  slug                             String @unique
  chat_credits                     Float  @default(0)
  call_credits                     Float  @default(0)
  updated_by_user                  String
  active_indian_calls              Int    @default(0)
  active_international_calls       Int    @default(0)
  available_indian_channels        Int    @default(1)
  available_international_channels Int    @default(1)
  expenses                         Float  @default(0)

  is_disabled Int      @default(0)
  is_deleted  Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  user_organisations UserOrganisation[]
  agents             Agent[]
  messages           Message[]
  leads              Lead[]
  costs              Cost[]
  credit_history     CreditHistory[]
  calls              Call[]
  chats              Chat[]

  @@index([slug])
  @@index([is_deleted, is_disabled])
}

model UserOrganisation {
  id              Int    @id @default(autoincrement())
  user_id         String
  organisation_id Int
  role            ROLE   @default(USER)

  is_disabled Int      @default(0)
  is_deleted  Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  user         User         @relation(fields: [user_id], references: [id], onDelete: Restrict)
  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)

  @@unique([user_id, organisation_id])
  @@index([organisation_id, role])
  @@index([user_id, is_deleted])
}

model Cost {
  id              Int       @id @default(autoincrement())
  organisation_id Int
  chat_id         Int?
  call_id         Int?
  message_id      Int?
  type            COST_TYPE
  amount          Float
  summary         String?

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)
  chat         Chat?        @relation(fields: [chat_id], references: [id], onDelete: Restrict)
  call         Call?        @relation(fields: [call_id], references: [id], onDelete: Restrict)
  message      Message?     @relation(fields: [message_id], references: [id], onDelete: Restrict)

  @@index([organisation_id, created_at])
  @@index([type, created_at])
  @@index([call_id])
  @@index([chat_id])
}

model CreditHistory {
  id              Int    @id @default(autoincrement())
  organisation_id Int
  change_amount   Float
  change_type     String
  change_field    String
  prev_value      Float
  new_value       Float
  reason          String

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)

  @@index([organisation_id, created_at])
  @@index([change_type, created_at])
}

model Agent {
  id              Int        @id @default(autoincrement())
  name            String
  slug            String     @unique
  phone_number    String?    @unique
  organisation_id Int
  base_prompt     String     @db.Text
  image_url       String?
  type            AGENT_TYPE @default(CALL)
  assistant_id    String?
  initial_prompt  String?    @db.Text
  analysis_prompt String?    @db.Text

  is_disabled     Int      @default(0)
  is_deleted      Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now()) @updatedAt
  updated_by_user String

  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)
  messages     Message[]
  leads        Lead[]
  calls        Call[]
  chats        Chat[]

  @@unique([slug, organisation_id])
  @@index([slug])
  @@index([organisation_id, is_deleted])
  @@index([phone_number])
}

model ZohoLeadOwner {
  id         String  @id
  first_name String?
  last_name  String?
  email      String?
  phone      String?

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  zoho_leads ZohoLead[]

  @@index([email])
  @@index([phone])
}

model ZohoLead {
  id                    String  @id
  lead_id               Int     @unique
  lead_owner_id         String
  first_name            String?
  last_name             String?
  email                 String?
  phone                 String?
  status                String?
  source                String?
  disposition           String?
  country               String?
  state                 String?
  city                  String?
  requires_human_action Int?    @default(0)
  is_handled_by_human   Int?    @default(0)

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  lead       Lead          @relation(fields: [lead_id], references: [id], onDelete: Restrict)
  lead_owner ZohoLeadOwner @relation(fields: [lead_owner_id], references: [id], onDelete: Restrict)

  @@index([lead_owner_id])
  @@index([status])
  @@index([requires_human_action])
  @@index([email])
  @@index([phone])
}

model Lead {
  id               Int       @id @default(autoincrement())
  first_name       String?
  last_name        String?
  email            String?
  phone_number     String?   @unique
  source           String?
  status           String?
  is_indian        Int       @default(0)
  follow_up_count  Int       @default(0)
  reschedule_count Int       @default(0)
  last_follow_up   DateTime?
  next_follow_up   DateTime?
  call_active      Int       @default(0)

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  organisations Organisation[]
  agents        Agent[]
  zoho_lead     ZohoLead?
  calls         Call[]
  chats         Chat[]

  @@index([phone_number])
  @@index([next_follow_up])
  @@index([status, is_deleted])
  @@index([call_active])
  @@index([email])
  @@index([is_indian])
}

model Call {
  id                Int         @id @default(autoincrement())
  organisation_id   Int
  agent_id          Int
  lead_id           Int
  status            String
  source            CALL_SOURCE
  direction         String
  from_number       String
  to_number         String
  started_at        DateTime
  ended_at          DateTime?
  duration          Float?
  summary           String?     @db.Text
  analysis          String?     @db.Text
  recording_url     String?     @db.Text
  call_ended_reason String?
  total_cost        Float?

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)
  agent        Agent        @relation(fields: [agent_id], references: [id], onDelete: Restrict)
  lead         Lead         @relation(fields: [lead_id], references: [id], onDelete: Restrict)
  messages     Message[]
  costs        Cost[]

  @@index([started_at])
  @@index([organisation_id, started_at])
  @@index([agent_id, started_at])
  @@index([lead_id, started_at])
  @@index([status, is_deleted])
  @@index([direction])
}

model Chat {
  id                Int         @id @default(autoincrement())
  organisation_id   Int
  agent_id          Int
  lead_id           Int?
  name              String?
  instagram_id      String?
  whatsapp_id       String?
  source            CHAT_SOURCE
  status            String
  summary           String?     @db.Text
  analysis          String?     @db.Text
  prompt_tokens     Int         @default(0)
  completion_tokens Int         @default(0)
  total_cost        Float?
  unread_messages   Int         @default(0)
  human_handled     Int         @default(0)

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  organisation Organisation @relation(fields: [organisation_id], references: [id], onDelete: Restrict)
  agent        Agent        @relation(fields: [agent_id], references: [id], onDelete: Restrict)
  lead         Lead?        @relation(fields: [lead_id], references: [id], onDelete: Restrict)
  messages     Message[]
  costs        Cost[]

  @@index([organisation_id, created_at])
  @@index([agent_id, created_at])
  @@index([lead_id, created_at])
  @@index([source, created_at])
  @@index([status, is_deleted])
}

model Message {
  id                Int          @id @default(autoincrement())
  organisation_id   Int
  agent_id          Int
  call_id           Int?
  chat_id           Int?
  role              String
  content           String?
  message_type      MESSAGE_TYPE @default(TEXT)
  prompt_tokens     Int          @default(0)
  completion_tokens Int          @default(0)
  total_cost        Float?

  is_deleted Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  agent        Agent               @relation(fields: [agent_id], references: [id], onDelete: Restrict)
  organisation Organisation        @relation(fields: [organisation_id], references: [id], onDelete: Restrict)
  call         Call?               @relation(fields: [call_id], references: [id], onDelete: Restrict)
  chat         Chat?               @relation(fields: [chat_id], references: [id], onDelete: Restrict)
  costs        Cost[]
  attachments  MessageAttachment[]

  @@index([call_id, created_at])
  @@index([chat_id, created_at])
  @@index([organisation_id, created_at])
  @@index([role])
  @@index([message_type])
}

model MessageAttachment {
  id            Int     @id @default(autoincrement())
  message_id    Int
  file_url      String
  file_name     String
  file_size     Int
  file_type     String // MIME type
  width         Int? // For images/videos
  height        Int? // For images/videos
  duration      Int? // For audio/videos in seconds
  thumbnail_url String? // For videos

  created_at DateTime @default(now())
  message    Message  @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@index([message_id])
}
